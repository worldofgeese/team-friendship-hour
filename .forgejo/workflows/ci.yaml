name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    container:
      image: docker.io/library/alpine:3.21

    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git nushell

      - name: Checkout code
        run: |
          git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git repo
          cd repo && git checkout ${{ github.sha }} || true

      - name: Run unit tests
        run: |
          cd repo
          sh run-tests.sh

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    container:
      image: docker.io/library/alpine:3.21

    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git nushell

      - name: Checkout code
        run: |
          git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git repo
          cd repo && git checkout ${{ github.sha }} || true

      - name: Check Nushell syntax
        run: |
          cd repo
          for f in $(find src tests -name "*.nu"); do
            nu -c "open $f | ignore" || exit 1
          done

  build:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: test
    container:
      image: quay.io/podman/stable:latest
      options: --privileged

    steps:
      - name: Install git
        run: |
          dnf install -y git

      - name: Checkout code
        run: |
          git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git repo
          cd repo && git checkout ${{ github.sha }} || true

      - name: Build container image
        run: |
          cd repo
          podman build --storage-driver=vfs -t team-friendship-hour:${{ github.sha }} -f Containerfile .
