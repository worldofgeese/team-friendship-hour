name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    container:
      image: docker.io/library/alpine:3.21

    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git nushell

      - name: Checkout code
        run: |
          git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git repo
          cd repo && git checkout ${{ github.sha }} || true

      - name: Run unit tests
        run: |
          cd repo
          nu run-tests.nu

  build:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Install git
        run: |
          apt-get update && apt-get install -y git

      - name: Checkout code
        run: |
          git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git repo
          cd repo && git checkout ${{ github.sha }} || true

      - name: Build container image
        run: |
          cd repo
          docker build -t team-friendship-hour:${{ github.sha }} -f Containerfile .

      - name: Test container startup
        run: |
          docker run -d --name test-container -p 8080:8080 team-friendship-hour:${{ github.sha }}
          sleep 5
          curl -f http://localhost:8080/ || exit 1
          docker stop test-container
          docker rm test-container

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    container:
      image: docker.io/library/alpine:3.21

    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache git nushell

      - name: Checkout code
        run: |
          git clone --depth 1 ${{ github.server_url }}/${{ github.repository }}.git repo
          cd repo && git checkout ${{ github.sha }} || true

      - name: Check Nushell syntax
        run: |
          cd repo
          for f in $(find src tests -name "*.nu"); do
            nu -c "open $f | ignore" || exit 1
          done
